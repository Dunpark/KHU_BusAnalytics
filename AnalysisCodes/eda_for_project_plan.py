"""
í”„ë¡œì íŠ¸ ì ˆì°¨ ì„¤ê³„ë¥¼ ìœ„í•œ ì¶”ê°€ EDA
- ìƒê¶Œë³„ ì„±ì¥ë¥  ê³„ì‚°
- êµ°ì§‘ ë³€ìˆ˜ í›„ë³´ íƒìƒ‰
- ì—…ì¢…Ã—ìƒê¶Œ êµì°¨ ë¶„ì„
- ìƒê´€ í–‰ë ¬
- ë¡œê·¸ ë³€í™˜ íš¨ê³¼
"""

import pandas as pd
import numpy as np
import warnings
warnings.filterwarnings('ignore')

# ë°ì´í„° ë¡œë“œ
print("=" * 80)
print("ğŸ“Š í”„ë¡œì íŠ¸ ì ˆì°¨ ì„¤ê³„ë¥¼ ìœ„í•œ ì¶”ê°€ EDA")
print("=" * 80)

file_path = '../Merged_datasets/4ê°œë…„_í†µí•©ë°ì´í„°_ì¶”ì •ë§¤ì¶œ_ìƒì£¼ì¸êµ¬_ì†Œë“ì†Œë¹„_ê¸¸ë‹¨ìœ„ì¸êµ¬_ì í¬_ì˜ì—­.csv'
df = pd.read_csv(file_path, encoding='utf-8')

# ì—°ë„/ë¶„ê¸° ì¶”ì¶œ
df['ê¸°ì¤€_ë…„_ì½”ë“œ'] = df['ê¸°ì¤€_ë…„ë¶„ê¸°_ì½”ë“œ'] // 10
df['ê¸°ì¤€_ë¶„ê¸°_ì½”ë“œ'] = df['ê¸°ì¤€_ë…„ë¶„ê¸°_ì½”ë“œ'] % 10

print(f"âœ… ë°ì´í„° ë¡œë”© ì™„ë£Œ: {len(df):,}ê±´")

# ============================================================================
# EDA 1: ìƒê¶Œë³„ ì‹œê³„ì—´ ì„±ì¥ë¥  ê³„ì‚°
# ============================================================================
print("\n" + "=" * 80)
print("1ï¸âƒ£ ìƒê¶Œë³„ ì‹œê³„ì—´ ì„±ì¥ë¥  ë¶„ì„")
print("=" * 80)

# ìƒê¶Œ-ì—…ì¢…ë³„ ì—°ë„ë³„ ë§¤ì¶œ ì§‘ê³„
yearly_sales = df.groupby(['ìƒê¶Œ_ì½”ë“œ', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ', 'ê¸°ì¤€_ë…„_ì½”ë“œ'])['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡'].sum().reset_index()

# 2021ë…„ ëŒ€ë¹„ 2024ë…„ ì„±ì¥ë¥  ê³„ì‚°
sales_2021 = yearly_sales[yearly_sales['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2021][['ìƒê¶Œ_ì½”ë“œ', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ', 'ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡']]
sales_2021.columns = ['ìƒê¶Œ_ì½”ë“œ', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ', 'ë§¤ì¶œ_2021']

sales_2024 = yearly_sales[yearly_sales['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2024][['ìƒê¶Œ_ì½”ë“œ', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ', 'ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡']]
sales_2024.columns = ['ìƒê¶Œ_ì½”ë“œ', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ', 'ë§¤ì¶œ_2024']

growth_df = pd.merge(sales_2021, sales_2024, on=['ìƒê¶Œ_ì½”ë“œ', 'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ'], how='inner')
growth_df['ì„±ì¥ë¥ '] = (growth_df['ë§¤ì¶œ_2024'] - growth_df['ë§¤ì¶œ_2021']) / growth_df['ë§¤ì¶œ_2021'] * 100

# ì„±ì¥ë¥  ë¶„í¬
print("\n[ìƒê¶Œ-ì—…ì¢…ë³„ ì„±ì¥ë¥  ë¶„í¬ (2021â†’2024)]")
print(f"  ë¶„ì„ ëŒ€ìƒ: {len(growth_df):,}ê°œ ìƒê¶Œ-ì—…ì¢… ì¡°í•©")
print(f"  í‰ê·  ì„±ì¥ë¥ : {growth_df['ì„±ì¥ë¥ '].mean():.1f}%")
print(f"  ì¤‘ì•™ê°’ ì„±ì¥ë¥ : {growth_df['ì„±ì¥ë¥ '].median():.1f}%")
print(f"  í‘œì¤€í¸ì°¨: {growth_df['ì„±ì¥ë¥ '].std():.1f}%")

# ì„±ì¥ë¥  ê¸°ì¤€ ë¶„ë¥˜
growth_df['ì„±ì¥_ë¶„ë¥˜'] = pd.cut(growth_df['ì„±ì¥ë¥ '], 
                              bins=[-np.inf, -20, 20, np.inf],
                              labels=['ì‡ í‡´(-20%ì´í•˜)', 'ì •ì²´(-20~20%)', 'ì„±ì¥(20%ì´ìƒ)'])

print("\n[ì„±ì¥ ë¶„ë¥˜ë³„ ë¹„ìœ¨]")
growth_class = growth_df['ì„±ì¥_ë¶„ë¥˜'].value_counts()
for cls, cnt in growth_class.items():
    pct = cnt / len(growth_df) * 100
    print(f"  {cls}: {cnt:,}ê°œ ({pct:.1f}%)")

# ìƒê¶Œ ë‹¨ìœ„ ì§‘ê³„
sangwon_growth = growth_df.groupby('ìƒê¶Œ_ì½”ë“œ')['ì„±ì¥ë¥ '].mean().reset_index()
sangwon_growth['ìƒê¶Œ_ì„±ì¥_ë¶„ë¥˜'] = pd.cut(sangwon_growth['ì„±ì¥ë¥ '], 
                                        bins=[-np.inf, -20, 20, np.inf],
                                        labels=['ì‡ í‡´', 'ì •ì²´', 'ì„±ì¥'])

print("\n[ìƒê¶Œ ë‹¨ìœ„ ì„±ì¥ ë¶„ë¥˜]")
sangwon_class = sangwon_growth['ìƒê¶Œ_ì„±ì¥_ë¶„ë¥˜'].value_counts()
for cls, cnt in sangwon_class.items():
    pct = cnt / len(sangwon_growth) * 100
    print(f"  {cls} ìƒê¶Œ: {cnt:,}ê°œ ({pct:.1f}%)")

# ============================================================================
# EDA 2: êµ°ì§‘ ë³€ìˆ˜ í›„ë³´ íƒìƒ‰
# ============================================================================
print("\n" + "=" * 80)
print("2ï¸âƒ£ êµ°ì§‘ ë¶„ì„ì„ ìœ„í•œ ë³€ìˆ˜ í›„ë³´ íƒìƒ‰")
print("=" * 80)

# ìƒê¶Œë³„ íŠ¹ì„± ì§‘ê³„ (ìµœì‹  ì—°ë„ ê¸°ì¤€)
df_2024 = df[df['ê¸°ì¤€_ë…„_ì½”ë“œ'] == 2024]

sangwon_features = df_2024.groupby('ìƒê¶Œ_ì½”ë“œ').agg({
    'ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡': 'mean',
    'ì í¬_ìˆ˜': 'mean',
    'ì´_ìƒì£¼ì¸êµ¬_ìˆ˜': 'mean',
    'ì´_ìœ ë™ì¸êµ¬_ìˆ˜': 'mean',
    'ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡': 'mean',
    'ì§€ì¶œ_ì´ê¸ˆì•¡': 'mean',
    'ì˜ì—­_ë©´ì ': 'mean',
    'ìœ ì‚¬_ì—…ì¢…_ì í¬_ìˆ˜': 'mean',
    'í”„ëœì°¨ì´ì¦ˆ_ì í¬_ìˆ˜': 'mean',
    'ê°œì—…_ì í¬_ìˆ˜': 'mean',
    'íì—…_ì í¬_ìˆ˜': 'mean',
    'ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ_ëª…': 'first'
}).reset_index()

print("\n[êµ°ì§‘ ë¶„ì„ í›„ë³´ ë³€ìˆ˜ ê¸°ìˆ í†µê³„]")
cluster_vars = ['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡', 'ì í¬_ìˆ˜', 'ì´_ìƒì£¼ì¸êµ¬_ìˆ˜', 'ì´_ìœ ë™ì¸êµ¬_ìˆ˜', 
                'ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡', 'ì˜ì—­_ë©´ì ', 'ìœ ì‚¬_ì—…ì¢…_ì í¬_ìˆ˜']

for var in cluster_vars:
    mean_val = sangwon_features[var].mean()
    std_val = sangwon_features[var].std()
    cv = std_val / mean_val * 100 if mean_val != 0 else 0
    print(f"  {var}: í‰ê· ={mean_val:,.0f}, ë³€ë™ê³„ìˆ˜(CV)={cv:.1f}%")

print("\nğŸ’¡ ë³€ë™ê³„ìˆ˜(CV)ê°€ ë†’ì„ìˆ˜ë¡ êµ°ì§‘ ë¶„ë¥˜ì— ìœ ìš©í•œ ë³€ìˆ˜")

# ============================================================================
# EDA 3: ì—…ì¢…Ã—ìƒê¶Œìœ í˜• êµì°¨ ë¶„ì„
# ============================================================================
print("\n" + "=" * 80)
print("3ï¸âƒ£ ì—…ì¢…Ã—ìƒê¶Œìœ í˜• êµì°¨ ë¶„ì„")
print("=" * 80)

# ì—…ì¢…-ìƒê¶Œìœ í˜•ë³„ í‰ê·  ë§¤ì¶œ
cross_sales = df.groupby(['ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ_ëª…', 'ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ_ëª…'])['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡'].mean().unstack()

# ê° ì—…ì¢…ë³„ ìµœì  ìƒê¶Œ ìœ í˜• ì°¾ê¸°
print("\n[ì—…ì¢…ë³„ ìµœê³  ë§¤ì¶œ ìƒê¶Œ ìœ í˜• (ìƒìœ„ 15ê°œ ì—…ì¢…)]")
top_services = df['ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ_ëª…'].value_counts().head(15).index

for service in top_services:
    if service in cross_sales.index:
        best_area = cross_sales.loc[service].idxmax()
        best_sales = cross_sales.loc[service].max()
        print(f"  {service}: {best_area} ({best_sales:,.0f}ì›)")

# ìƒê¶Œìœ í˜•ë³„ ê³ ë§¤ì¶œ ì—…ì¢… TOP 3
print("\n[ìƒê¶Œìœ í˜•ë³„ ê³ ë§¤ì¶œ ì—…ì¢… TOP 3]")
for area_type in cross_sales.columns:
    print(f"\n  [{area_type}]")
    top3 = cross_sales[area_type].sort_values(ascending=False).head(3)
    for i, (service, sales) in enumerate(top3.items(), 1):
        print(f"    {i}. {service}: {sales:,.0f}ì›")

# ============================================================================
# EDA 4: ìƒê´€ í–‰ë ¬ (ë‹¤ì¤‘ê³µì„ ì„± ì²´í¬)
# ============================================================================
print("\n" + "=" * 80)
print("4ï¸âƒ£ ì£¼ìš” ë³€ìˆ˜ ìƒê´€ í–‰ë ¬ (ë‹¤ì¤‘ê³µì„ ì„± ì²´í¬)")
print("=" * 80)

corr_vars = ['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡', 'ì í¬_ìˆ˜', 'ì´_ìƒì£¼ì¸êµ¬_ìˆ˜', 'ì´_ìœ ë™ì¸êµ¬_ìˆ˜', 
             'ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡', 'ì§€ì¶œ_ì´ê¸ˆì•¡', 'ì˜ì—­_ë©´ì ', 'ìœ ì‚¬_ì—…ì¢…_ì í¬_ìˆ˜']

corr_matrix = df[corr_vars].corr()

print("\n[ìƒê´€ê³„ìˆ˜ í–‰ë ¬ - ë†’ì€ ìƒê´€ê´€ê³„ ìŒ (|r| > 0.7)]")
high_corr_pairs = []
for i in range(len(corr_vars)):
    for j in range(i+1, len(corr_vars)):
        corr_val = corr_matrix.iloc[i, j]
        if abs(corr_val) > 0.7:
            high_corr_pairs.append((corr_vars[i], corr_vars[j], corr_val))
            print(f"  {corr_vars[i]} â†” {corr_vars[j]}: {corr_val:.3f}")

if not high_corr_pairs:
    print("  ë†’ì€ ìƒê´€ê´€ê³„(|r|>0.7) ìŒ ì—†ìŒ â†’ ë‹¤ì¤‘ê³µì„ ì„± ìš°ë ¤ ë‚®ìŒ âœ…")

print("\n[ë§¤ì¶œê³¼ì˜ ìƒê´€ê´€ê³„ ìˆœìœ„]")
sales_corr = corr_matrix['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡'].sort_values(ascending=False)
for var, corr in sales_corr.items():
    if var != 'ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡':
        print(f"  {var}: {corr:.3f}")

# ============================================================================
# EDA 5: ë¡œê·¸ ë³€í™˜ íš¨ê³¼ í™•ì¸
# ============================================================================
print("\n" + "=" * 80)
print("5ï¸âƒ£ ë¡œê·¸ ë³€í™˜ íš¨ê³¼ í™•ì¸")
print("=" * 80)

# ì›ë³¸ vs ë¡œê·¸ ë³€í™˜ ì™œë„ ë¹„êµ
skew_comparison = []
for var in ['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡', 'ì í¬_ìˆ˜', 'ì´_ìœ ë™ì¸êµ¬_ìˆ˜', 'ì˜ì—­_ë©´ì ']:
    original_skew = df[var].skew()
    # 0ë³´ë‹¤ í° ê°’ë§Œ ë¡œê·¸ ë³€í™˜
    log_values = np.log1p(df[var])
    log_skew = log_values.skew()
    skew_comparison.append({
        'ë³€ìˆ˜': var,
        'ì›ë³¸_ì™œë„': original_skew,
        'ë¡œê·¸ë³€í™˜_ì™œë„': log_skew,
        'ê°œì„ ìœ¨': (abs(original_skew) - abs(log_skew)) / abs(original_skew) * 100
    })

print("\n[ì™œë„ ë¹„êµ: ì›ë³¸ vs ë¡œê·¸ ë³€í™˜]")
print(f"{'ë³€ìˆ˜':<25} {'ì›ë³¸ ì™œë„':>12} {'ë¡œê·¸ ì™œë„':>12} {'ê°œì„ ìœ¨':>10}")
print("-" * 65)
for item in skew_comparison:
    print(f"{item['ë³€ìˆ˜']:<25} {item['ì›ë³¸_ì™œë„']:>12.2f} {item['ë¡œê·¸ë³€í™˜_ì™œë„']:>12.2f} {item['ê°œì„ ìœ¨']:>9.1f}%")

print("\nğŸ’¡ ë¡œê·¸ ë³€í™˜ìœ¼ë¡œ ì™œë„ê°€ 0ì— ê°€ê¹Œì›Œì§€ë©´ ì •ê·œë¶„í¬ì— ê·¼ì ‘ â†’ íšŒê·€ ë¶„ì„ì— ìœ ë¦¬")

# ============================================================================
# ì¶”ê°€: ì˜ˆì¸¡ ëª¨ë¸ì„ ìœ„í•œ íƒ€ê¹ƒ ë³€ìˆ˜ í›„ë³´
# ============================================================================
print("\n" + "=" * 80)
print("6ï¸âƒ£ ì˜ˆì¸¡ ëª¨ë¸ íƒ€ê¹ƒ ë³€ìˆ˜ í›„ë³´ ë¶„ì„")
print("=" * 80)

# íƒ€ê¹ƒ 1: ë§¤ì¶œ ê¸ˆì•¡ (íšŒê·€)
print("\n[íƒ€ê¹ƒ 1: ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡ (íšŒê·€ ë¬¸ì œ)]")
print(f"  ë°ì´í„° ìˆ˜: {len(df):,}")
print(f"  í‰ê· : {df['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡'].mean():,.0f}ì›")
print(f"  ì¶”ì²œ: ë¡œê·¸ ë³€í™˜ í›„ íšŒê·€ ë¶„ì„")

# íƒ€ê¹ƒ 2: ê³ ë§¤ì¶œ ì—¬ë¶€ (ë¶„ë¥˜)
threshold_75 = df['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡'].quantile(0.75)
df['ê³ ë§¤ì¶œ_ì—¬ë¶€'] = (df['ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡'] >= threshold_75).astype(int)

print(f"\n[íƒ€ê¹ƒ 2: ê³ ë§¤ì¶œ ì—¬ë¶€ (ë¶„ë¥˜ ë¬¸ì œ, ìƒìœ„ 25% ê¸°ì¤€)]")
print(f"  ê¸°ì¤€ê°’: {threshold_75:,.0f}ì›")
print(f"  ê³ ë§¤ì¶œ(1): {df['ê³ ë§¤ì¶œ_ì—¬ë¶€'].sum():,}ê±´ ({df['ê³ ë§¤ì¶œ_ì—¬ë¶€'].mean()*100:.1f}%)")
print(f"  ì €ë§¤ì¶œ(0): {(1-df['ê³ ë§¤ì¶œ_ì—¬ë¶€']).sum():,}ê±´ ({(1-df['ê³ ë§¤ì¶œ_ì—¬ë¶€'].mean())*100:.1f}%)")

# íƒ€ê¹ƒ 3: ì„±ì¥/ì‡ í‡´ ë¶„ë¥˜
print(f"\n[íƒ€ê¹ƒ 3: ìƒê¶Œ ì„±ì¥ ë¶„ë¥˜ (2021â†’2024 ì„±ì¥ë¥  ê¸°ë°˜)]")
print(f"  ì„±ì¥(+20% ì´ìƒ): {(sangwon_growth['ìƒê¶Œ_ì„±ì¥_ë¶„ë¥˜']=='ì„±ì¥').sum()}ê°œ ìƒê¶Œ")
print(f"  ì •ì²´(-20~+20%): {(sangwon_growth['ìƒê¶Œ_ì„±ì¥_ë¶„ë¥˜']=='ì •ì²´').sum()}ê°œ ìƒê¶Œ")
print(f"  ì‡ í‡´(-20% ì´í•˜): {(sangwon_growth['ìƒê¶Œ_ì„±ì¥_ë¶„ë¥˜']=='ì‡ í‡´').sum()}ê°œ ìƒê¶Œ")

# ============================================================================
# ê²°ë¡  ìš”ì•½
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ“‹ EDA ê²°ë¡  ìš”ì•½ - í”„ë¡œì íŠ¸ ì ˆì°¨ ì„¤ê³„ ì‹œ ë°˜ì˜ ì‚¬í•­")
print("=" * 80)

print("""
[1] íƒ€ê¹ƒ ë³€ìˆ˜ ì„¤ì •
    â€¢ íšŒê·€: log(ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡) - ë¡œê·¸ ë³€í™˜ í•„ìˆ˜
    â€¢ ë¶„ë¥˜: ê³ ë§¤ì¶œ ì—¬ë¶€ (ìƒìœ„ 25%), ì„±ì¥/ì‡ í‡´ ë¶„ë¥˜ (3í´ë˜ìŠ¤)

[2] êµ°ì§‘ ë¶„ì„ ë³€ìˆ˜ (k-means)
    â€¢ ì¶”ì²œ: ì í¬_ìˆ˜, ì´_ìœ ë™ì¸êµ¬_ìˆ˜, ì˜ì—­_ë©´ì , ìœ ì‚¬_ì—…ì¢…_ì í¬_ìˆ˜
    â€¢ z-score í‘œì¤€í™” í•„ìˆ˜

[3] íšŒê·€/ë¶„ë¥˜ ëª¨ë¸ ì„¤ëª… ë³€ìˆ˜
    â€¢ ì í¬ ê´€ë ¨: ì í¬_ìˆ˜, ìœ ì‚¬_ì—…ì¢…_ì í¬_ìˆ˜, í”„ëœì°¨ì´ì¦ˆ_ì í¬_ìˆ˜
    â€¢ ì¸êµ¬ ê´€ë ¨: ì´_ìœ ë™ì¸êµ¬_ìˆ˜, ì´_ìƒì£¼ì¸êµ¬_ìˆ˜
    â€¢ ì†Œë“ ê´€ë ¨: ì›”_í‰ê· _ì†Œë“_ê¸ˆì•¡
    â€¢ ì˜ì—­: ì˜ì—­_ë©´ì 
    â€¢ ë²”ì£¼í˜• ë”ë¯¸: ìƒê¶Œ_êµ¬ë¶„_ì½”ë“œ, ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ

[4] ì „ì²˜ë¦¬ ì „ëµ
    â€¢ ë§¤ì¶œ: ë¡œê·¸ ë³€í™˜ (ì™œë„ 69.8 â†’ ì•½ 0ìœ¼ë¡œ ê°œì„ )
    â€¢ ì í¬ ìˆ˜: ë¡œê·¸ ë³€í™˜ (ì™œë„ 91.0 â†’ ê°œì„ )
    â€¢ ìˆ˜ì¹˜í˜•: z-score í‘œì¤€í™” (êµ°ì§‘/k-NNìš©)

[5] ë‹¤ì¤‘ê³µì„ ì„±
    â€¢ ë†’ì€ ìƒê´€ê´€ê³„(|r|>0.7) ìŒ ì—†ìŒ â†’ ë³€ìˆ˜ ì„ íƒ ììœ ë„ ë†’ìŒ

[6] ì—…ì¢…ë³„ ìµœì  ìƒê¶Œ ë§¤ì¹­
    â€¢ ê´€ê´‘íŠ¹êµ¬: ê³ ë§¤ì¶œ ì—…ì¢… ì§‘ì¤‘ (ì˜ë¥˜, ìˆ˜ì‚°ë¬¼ ë“±)
    â€¢ ë°œë‹¬ìƒê¶Œ: ìŒì‹ì , ì˜ë£Œ ë“±
    â€¢ ê³¨ëª©ìƒê¶Œ: ë¯¸ìš©ì‹¤, ì„¸íƒì†Œ ë“± ìƒí™œë°€ì°©í˜•
""")

print("=" * 80)
print("âœ… ì¶”ê°€ EDA ì™„ë£Œ!")
print("=" * 80)

